#!/usr/bin/env php
<?php

declare(strict_types=1);

require getenv('DOTS_DIR') . '/vendor/autoload.php';

use Symfony\Component\BrowserKit\HttpBrowser;
use Symfony\Component\DomCrawler\Crawler;

$prog = new class {
    private string $document = '';

    /**
     * Execute the console command.
     */
    public function handle(string $url, string $startNum, string $endNum)
    {
        $browser = new HttpBrowser;

        $this->document .= '<style>' . $this->getStyle() . '</style>';

        foreach (range($startNum, $endNum) as $num) {
            $url = str_replace('{}', $num, $url);
            $browser->request('GET', $url);

            $crawler = $browser->getCrawler();
            $crawler->filter('table table table table')
                ->each(function (Crawler $el) {
                    if (!str_contains($el->html(), 'bibl_knyga')) {
                        return;
                    }

                    $remove = [
                        '<tr align="left" valign="top"><td colspan="2" class="bibl_isnasa_vardas">Bibliografiniai duomenys:</td></tr><tr align="left" valign="top"><td colspan="2"><p>ŠVENTASIS RAŠTAS. Senasis ir Naujasis Testamentas. – Vilnius: Lietuvos Katalikų  Vyskupų Konferencija, 1998.</p> <p>© Lietuvos Vyskupų Konferencija, 1998. <a href="http://biblija.lt/index.aspx/lt_vertimai/leidimai/b_rk_k1998/">Išsamiai apie leidimą &gt;&gt;</a></p> </td> </tr>',
                        '<tr align="left" valign="top"><td colspan="2" class="bibl_isnasa_vardas">Bibliografiniai duomenys:</td></tr><tr align="left" valign="top"><td colspan="2" class="bibl_isnasa"><p>BIBLIJA arba ŠVENTASIS RAŠTAS. Ekumeninis leidimas. – Vilnius: Lietuvos Biblijos draugija, 1999.</p><p>© Lietuvos Biblijos draugija, 1999<br> © Lietuvos Vyskupų Konferencija, 1999. <a href="http://biblija.lt/index.aspx/lt_vertimai/leidimai/b_rk_e1999/">Išsamiai apie leidimą &gt;&gt;</a></p></td></tr>',
                    ];

                    $contents = str_replace($remove, '', $el->html());

                    $this->document .= '<table width="100%" border="0" cellspacing="2" a=""><tbody>' . $contents . '</tbody></table>';
                });
        }

        echo $this->document . "\n";
    }

    private function getstyle(): string
    {
        return file_get_contents(getenv('DOTS_DIR') . '/etc/bible-style.css');
    }
};

if ($argc !== 4) {
    echo "Usage: {url} {startNum} {endNum}\n";
    echo "Use {} as replacement fragment for numbers in URL\n";
    exit(1);
}

$prog->handle($argv[1], $argv[2], $argv[3]);
