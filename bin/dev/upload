#!/usr/bin/env bash
# Upload changes to remote server

#[ -z "$1" ] && REMOTE_HOST="$1"
#[ -z "$2" ] && REMOTE_ROOT="$2"

host="$REMOTE_USER@$REMOTE_HOST"

echo "Host: $host"

if [ -z "$1" ]; then
    files=()

    for file in $(git diff --cached --name-only); do
        files+=("$file")
    done
else
    files=("$@")
fi

if [ ${#files[@]} -eq 0 ]; then
    echo 'E: No files to transfer'>&2
    exit 1
fi

rsync -RPrzcav --keep-dirlinks "${files[@]}" "$host:$REMOTE_ROOT"

if [ -f artisan ]; then
    ssh "$host" "(cd '$REMOTE_ROOT' && php cachetool.phar opcache:reset --cli; php artisan horizon:terminate; php artisan optimize)"
fi
