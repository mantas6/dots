#!/usr/bin/env bash

set -e

root=$(git rev-parse --git-dir)
msg_file="$root/glz-msg"

add=true

last_msg=
[ -f "$msg_file" ] && last_msg=$(<"$msg_file")

while getopts 'in' opt; do
    case ${opt} in
    n)
        add=false
        ;;
    ?)
        exit 1
        ;;
    esac
done

if [ -z "$(git status --porcelain)" ]; then
    exit 0
fi

if $add; then
    git add .
    git diff --staged
fi

msg=$(gum write --show-line-numbers --height=5 --placeholder 'Commit message' --value="$last_msg")

echo "$msg"

git commit -m "$msg"
printf '%s' "$msg" >"$msg_file"

if git ls-remote --exit-code --heads origin "$(git branch --show-current)" >/dev/null 2>&1; then
    git pull --no-edit
fi

git push
