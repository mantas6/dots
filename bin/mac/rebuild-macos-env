#!/usr/bin/env bash

# Set for brew to pickup brew.env
export XDG_CONFIG_HOME="$HOME/.config"

[ "$(uname)" != 'Darwin' ] && exit 1

fn-brew() {
    local dir="$HOME/.local/brew"

    if [ ! -x "$(command -v brew)" ]; then
        git clone https://github.com/Homebrew/brew "$dir"

        export HOMEBREW_PREFIX="$dir"
        export PATH="$HOMEBREW_PREFIX/bin:$PATH"

        eval "$(brew shellenv)"

        brew update --force --quiet
        chmod -R go-w "$(brew --prefix)/share/zsh"

        brew install stow

        echo 'Restart the shell, run stow and then re-run this command'
        exit 0
    else
        brew bundle --global
    fi
}

fn-defaults() {
    defaults write -g InitialKeyRepeat -int 15
    defaults write -g KeyRepeat -int 1

    defaults write com.apple.menuextra.clock DateFormat -string "\"EEE d MMM HH:mm:ss\""
    defaults write com.apple.finder CreateDesktop -bool false
    defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
    defaults write com.apple.finder FXRemoveOldTrashItems -bool true
    defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

    defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

    defaults write -g NSWindowShouldDragOnGesture -bool true
    defaults write com.apple.dock expose-group-apps -bool true
    defaults write com.apple.spaces spans-displays -bool true
    defaults write -g NSAutomaticWindowAnimationsEnabled -bool false

    defaults write com.apple.dock show-recents -bool false

    defaults write com.apple.Safari ShowFullURLInSmartSearchField -bool true
    defaults write com.apple.finder _FXSortFoldersFirst -bool true
    defaults write com.apple.finder ShowPathbar -bool true
    defaults write -g com.apple.sound.uiaudio.enabled -int 0

    defaults write com.apple.dock autohide -bool true
    # defaults write NSGlobalDomain _HIHideMenuBar -bool true

    # Get and set later:
    # defaults read NSGlobalDomain com.apple.mouse.scaling
    # defaults write NSGlobalDomain com.apple.mouse.scaling -float "4"
    #
    # defaults read com.apple.dock autohide-delay
    # defaults write com.apple.Dock autohide-delay -float "0.7"
    #
    # defaults read NSGlobalDomain com.apple.trackpad.scaling
    # defaults write NSGlobalDomain com.apple.trackpad.scaling -float "4"

    killall SystemUIServer
    killall Dock
    killall Finder
}

fn-node() {
    if [ ! -x "$(command -v nvm)" ]; then
        (
            export NVM_DIR="$HOME/.local/share/nvm"

            git clone https://github.com/nvm-sh/nvm.git "$NVM_DIR"

            cd "$NVM_DIR" || exit 1
            # git checkout v0.40.3

            \. "$NVM_DIR/nvm.sh"
            nvm install node
            nvm use node
        )
    fi
}

fn-php() {
    bash -c "$(curl -fsSL https://php.new/install/mac/8.4)"
}

fn-misc() {
    if [ ! -x "$(command -v carl)" ]; then
        cargo install carl
    fi

    rm -rf "$HOME/.qutebrowser"
    ln -s "$HOME/.config/qutebrowser" "$HOME/.qutebrowser"

    local fzf_tab_path="$HOME/.local/state/zsh/fzf-tab"
    if [ ! -d "$fzf_tab_path" ]; then
        git clone https://github.com/Aloxaf/fzf-tab "$fzf_tab_path"
    else
        (cd "$fzf_tab_path" && git pull)
    fi
}

fn-init() {
    fn-brew
    fn-node
    fn-php
    fn-misc
    fn-defaults
}

for arg in "$@"; do
    "fn-$arg" || exit 1
done
